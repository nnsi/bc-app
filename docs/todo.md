# beatmania IIDX Controller Tracker - DP (Double Play) Mode Implementation

## 設計方針

### 1. モード切り替え
- SPモード（シングルプレイ）：現行の1コントローラー表示
- DPモード（ダブルプレイ）：2コントローラーを横並び表示
- モード切り替えは設定画面から実行

### 2. コントローラー管理
- 最大2つのゲームパッドを同時認識
- 1P側/2P側への割り当て機能
- 未接続時は該当側をグレーアウト表示

### 3. ウィンドウサイズ
- SPモード：410x250px（現行）
- DPモード：820x250px（横幅2倍）
- モード切り替え時に動的にリサイズ

### 4. データ構造
- 既存の`ControllerStatus`を維持（後方互換性）
- DPモード用に`DPControllerStatus`を追加
- WebSocketで送信モードを識別できる形式

## 実装タスクリスト

### Phase 1: 基盤整備

- [x] **データ構造の定義**
  - [x] `DPControllerStatus`インターフェースの作成
  - [x] プレイモード型（`'SP' | 'DP'`）の定義
  - [x] WebSocket送信データ形式の拡張

- [x] **設定管理の実装**
  - [x] プレイモード設定の状態管理
  - [x] localStorage への設定保存
  - [x] 設定初期値の定義

### Phase 2: 複数コントローラー対応

- [x] **ゲームパッド管理の拡張**
  - [x] `useGamepadDetection`フックの拡張（複数ゲームパッド対応）
  - [x] ゲームパッドインデックスの配列管理
  - [x] 1P/2P側への割り当てロジック

- [x] **useControllerフックの改修**
  - [x] 複数ゲームパッドの状態を同時に追跡
  - [x] DPモード時の統合データ生成
  - [x] SPモードとの互換性維持

### Phase 3: UI実装

- [x] **設定画面の実装**
  - [x] プレイモード切り替えUI（SP/DP）
  - [x] DPモード時のコントローラー割り当てUI
  - [x] ゲームパッド選択の拡張（2つまで選択可能）

- [x] **コントローラー表示の拡張**
  - [x] DPモード用レイアウトコンポーネント作成
  - [x] 1P/2P側の識別表示
  - [x] 未接続コントローラーのグレーアウト表示

- [x] **統計表示の改修**
  - [x] DPモード時の統合統計表示
  - [x] 1P/2P個別統計の切り替え機能

### Phase 4: ウィンドウ管理

- [x] **Tauri側の実装**
  - [x] ウィンドウリサイズAPIの実装
  - [x] モード切り替え時のウィンドウサイズ変更
  - [x] ウィンドウ位置の調整（センタリング）

- [x] **フロントエンド連携**
  - [x] モード切り替え時のリサイズ要求
  - [x] レスポンシブ対応（ウィンドウサイズに応じた表示）

### Phase 5: WebSocket通信

- [x] **送信データの拡張**
  - [x] モード情報を含むデータ送信
  - [x] DPモード時の両コントローラーデータ送信
  - [x] 後方互換性の確保（SPクライアント対応）

- [x] **受信処理の改修**
  - [x] 受信データのモード判定
  - [x] DPデータの適切な処理
  - [x] エラーハンドリング

### Phase 6: テストと最適化

- [ ] **動作テスト**
  - [ ] SP→DP→SPモード切り替えテスト
  - [ ] 複数コントローラー同時入力テスト
  - [ ] WebSocket通信の安定性確認

- [ ] **パフォーマンス最適化**
  - [ ] 2コントローラー同時ポーリングの最適化
  - [ ] レンダリング負荷の確認と改善
  - [ ] メモリ使用量の監視

### Phase 7: ユーザビリティ向上

- [ ] **UI/UXの改善**
  - [ ] モード切り替えアニメーション
  - [ ] キーボードショートカット（モード切り替え）
  - [ ] 設定画面のアクセシビリティ向上

- [ ] **エラーハンドリング**
  - [ ] コントローラー切断時の処理
  - [ ] WebSocket接続エラーの表示
  - [ ] 設定の検証とフォールバック

## 優先度と見積もり

1. **必須機能**（Phase 1-5）：基本的なDP機能の実装
2. **品質向上**（Phase 6）：安定性とパフォーマンス
3. **追加改善**（Phase 7）：ユーザビリティ向上

各Phaseは順次実装し、Phase 5完了時点で基本的なDPモードが動作する状態を目指す。