# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際のClaude Code (claude.ai/code) へのガイダンスを提供します。

## 🔨 最重要ルール - 新しいルールの追加プロセス

ユーザーから今回限りではなく常に対応が必要だと思われる指示を受けた場合：

1. 「これを標準のルールにしますか？」と質問する
2. YESの回答を得た場合、CLAUDE.mdに追加ルールとして記載する
3. 以降は標準ルールとして常に適用する

## 開発コマンド

- `npm run dev` - 開発サーバーを起動（Reactフロントエンド、localhost:1420）
- `npm run build` - 本番用ビルド（TypeScriptコンパイル + Viteビルド）
- `npm run preview` - 本番ビルドのプレビュー
- `npm run tauri dev` - Tauriアプリを開発モードで実行（フロントエンド開発サーバーを含む）
- `npm run tauri build` - Tauriアプリの本番用ビルド

Windows環境で動かしているので、Claude Codeがnpm run devを行うのは禁止です。

## アーキテクチャ概要

これは以下の技術で構築された**beatmania IIDX コントローラー入力トラッカー**です：

- **フロントエンド**: React + TypeScript + Vite
- **デスクトップアプリ**: Tauri (Rustバックエンド)
- **スタイリング**: styled-components + Material-UIアイコン
- **リアルタイム通信**: WebSocketサーバー（マルチクライアント対応）

### 主要コンポーネント

**フロントエンドアーキテクチャ:**

- `App.tsx` - ゲームパッド選択、WebSocket接続、モード切り替えを含むメインアプリケーション
- `useController.ts` - ゲームパッド状態をポーリングし、ボタン押下を追跡し、タイミングメトリクスを計算するコアフック
- `IIDXController.tsx` - IIDXコントローラーの視覚的表現（スクラッチ + 7鍵）
- `BeatStatus.tsx` - ビート統計とパフォーマンスメトリクスを表示

**バックエンド (Rust/Tauri):**

- `main.rs` - クライアント間でのリアルタイムデータ共有用のポート2356でのWebSocketサーバー
- ゲームパッド入力アクセス用に`tauri-plugin-gamepad`を使用
- 透明度とカスタムデコレーションを持つウィンドウ管理

### データフロー

1. **コントローラーポーリング**: `useController`フックが5msごとにゲームパッド状態をポーリング
2. **状態処理**: ボタン押下/離脱タイミング、スクラッチ方向、ストローク数を追跡
3. **WebSocketブロードキャスト**: 接続されたクライアントにコントローラーデータをリアルタイムで送信
4. **視覚的更新**: Reactコンポーネントがコントローラー状態とメトリクスをレンダリング

### 主要機能

- **デュアルモード動作**: クライアントモード（ローカルゲームパッド）vs サーバーモード（WebSocket経由でデータ受信）
- **精密タイミング**: キー離脱時間を追跡、ロングノート（>200ms）をフィルタリング
- **スクラッチ検出**: 状態持続性を持つスクラッチ方向検出
- **リアルタイムメトリクス**: ビート密度、リリース速度統計
- **マルチクライアント対応**: WebSocketサーバーにより複数のインスタンスでデータ共有可能

### 設定メモ

- WebSocketサーバーは`127.0.0.1:2356`で動作
- ゲームパッドポーリング間隔: 5ms
- IIDXボタンマッピング: `{5: 0, 1: 1, 2: 2, 4: 3, 7: 4, 8: 5, 9: 6}` （物理ボタンを1-7鍵にマッピング）
- ウィンドウ設定: 410x250px、透明、リサイズ不可
- データ保持制限: リリース時間2000回、プレス時間500回

## テスト

特定のテストフレームワークは設定されていません。手動テストはIIDXコントローラーを接続して入力追跡精度を確認することで行います。
